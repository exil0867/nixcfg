name: Update Flake Lockfile

on:
  schedule:
    # Twice a week: Sunday and Wednesday at 00:00 UTC
    - cron: '0 0 * * 0'
    - cron: '0 0 * * 3'
  workflow_dispatch:

jobs:
  update-flake:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Configure Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Update flake lockfile
        run: nix flake update

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet flake.lock; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate lockfile summary
        if: steps.check_changes.outputs.has_changes == 'true'
        id: lockfile_summary
        run: |
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          nix flake metadata --json \
            | jq -r '.locks.nodes
              | to_entries
              | map(select(.key != "root"))
              | map("- **\(.key)**: \(.value.original.owner // "N/A")/\(.value.original.repo // .value.original.url // "N/A") (\(.value.locked.rev[0:7] // "N/A"))")
              | join("\n")' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create or update Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update flake lockfile"
          title: "üîÑ Update NixOS Flake Dependencies"
          branch: update-flake-lockfile
          delete-branch: true
          body: |
            ## Automated Flake Lockfile Update

            This PR tracks rolling updates to `flake.lock`.

            ### Latest Update
            ${{ steps.lockfile_summary.outputs.summary }}

            ### Required Testing

            - [ ] **kairos** - `sudo nixos-rebuild switch --flake .#kairos`
            - [ ] **echo** - `sudo nixos-rebuild switch --flake .#echo`
            - [ ] **sky** - `sudo nixos-rebuild switch --flake .#sky`

            This PR is force-updated on every run.
          labels: |
            automated
            dependencies

      - name: Comment on existing PR with update summary
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-or-update-comment@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ steps.cpr.outputs.pull-request-number }}
          body: |
            üîÅ **Flake lockfile updated again**

            **Run timestamp:** `${{ github.run_id }}`

            **Updated inputs:**
            ${{ steps.lockfile_summary.outputs.summary }}
